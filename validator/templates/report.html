{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Validation Report #{{ report.id }}</h2>
    <div class="d-flex align-items-center gap-3">
        <form method="POST" action="{% url 'validator:input' %}" class="m-0 p-0 no-print" onsubmit="document.querySelector('.loader-overlay').style.display='flex'">
            {% csrf_token %}
            <input type="hidden" name="zeplin_project_id" value="{{ report.zeplin_project_id }}">
            <input type="hidden" name="zeplin_screen_id" value="{{ report.zeplin_screen_id }}">
            <input type="hidden" name="live_url" value="{{ report.live_url }}">
            <button type="submit" class="btn btn-primary fw-bold shadow-sm" title="Re-run validation for this screen">
                üîÑ Rescan
            </button>
        </form>
        <div class="dropdown no-print">
            <button class="btn btn-outline-dark dropdown-toggle shadow-sm fw-bold" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                üíæ Export Report
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow">
                <li><button id="btnPreviewHtml" class="dropdown-item py-2" onclick="previewAndDownloadHTML()">üåê Preview & Download Standalone HTML</button></li>
                <li><button class="dropdown-item py-2" onclick="downloadPDF()">üìÑ Download as PDF</button></li>
            </ul>
        </div>
        {% if report.status == 'PASS' %}
            <span class="badge bg-success px-4 py-2 fs-5 text-uppercase">PASS</span>
        {% else %}
            <span class="badge bg-danger px-4 py-2 fs-5 text-uppercase">FAIL</span>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light fw-bold">Summary</div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>Date:</strong> {{ report.created_at|date:"Y-m-d H:i:s" }}</li>
                <li class="list-group-item"><strong>Project ID:</strong> {{ report.zeplin_project_id }}</li>
                <li class="list-group-item"><strong>Screen ID:</strong> {{ report.zeplin_screen_id }}</li>
                <li class="list-group-item text-truncate"><strong>Live URL:</strong> <a href="{{ report.live_url }}" target="_blank">{{ report.live_url }}</a></li>
                <li class="list-group-item bg-light border-top">
                    <div class="row text-center mt-2">
                        <div class="col-6 border-end">
                            <h6 class="text-muted fw-bold mb-1">Zeplin Layers</h6>
                            <span class="fs-5">{{ report.zeplin_layer_count|default:"-" }}</span>
                        </div>
                        <div class="col-6">
                            <h6 class="text-muted fw-bold mb-1">Live DOM Nodes</h6>
                            <span class="fs-5">{{ report.dom_node_count|default:"-" }}</span>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-light fw-bold">Results</div>
            <ul class="list-group list-group-flush h-100">
                <li class="list-group-item d-flex justify-content-between align-items-center flex-fill">
                    <span class="fw-bold">Pixel Mismatches <span class="text-muted fw-normal">(Tolerance: 10%)</span></span>
                    {% if report.pixel_mismatch_count > 5000 %}
                        <span class="badge bg-danger rounded-pill fs-6">{{ report.pixel_mismatch_count }}</span>
                    {% else %}
                        <span class="badge bg-success rounded-pill fs-6">{{ report.pixel_mismatch_count }}</span>
                    {% endif %}
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center flex-fill">
                    <span class="fw-bold">CSS Defect Count</span>
                    {% if report.css_mismatch_count > 0 %}
                        <span class="badge bg-danger rounded-pill fs-6">{{ report.css_mismatch_count }}</span>
                    {% else %}
                        <span class="badge bg-success rounded-pill fs-6">{{ report.css_mismatch_count }}</span>
                    {% endif %}
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center flex-fill">
                    <span class="fw-bold">JavaScript Errors</span>
                    {% if report.js_error_count > 0 %}
                        <span class="badge bg-danger rounded-pill fs-6">{{ report.js_error_count }}</span>
                    {% else %}
                        <span class="badge bg-success rounded-pill fs-6">{{ report.js_error_count }}</span>
                    {% endif %}
                </li>
            </ul>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-5">
    <div class="card-header bg-light fw-bold">Visual Comparison</div>
    <div class="card-body">
        <div class="row g-4">
            <div class="col-lg-4 col-md-12">
                <h5 class="text-center text-muted mb-3">Zeplin Design</h5>
                <div class="border rounded text-center bg-white p-2" style="height: 400px; overflow: auto;">
                    {% if report.design_image %}
                    <img src="{{ report.design_image.url }}" class="img-fluid" alt="Design">
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <h5 class="text-center text-muted mb-3">Live Result</h5>
                <div class="border rounded text-center bg-white p-2" style="height: 400px; overflow: auto;">
                    {% if report.live_image %}
                    <img src="{{ report.live_image.url }}" class="img-fluid" alt="Live">
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <h5 class="text-center text-muted mb-3">Pixel Diff Map</h5>
                <div class="border rounded text-center bg-white p-2" style="height: 400px; overflow: auto;">
                    {% if report.diff_image %}
                    <img src="{{ report.diff_image.url }}" class="img-fluid" alt="Difference">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if report.css_mismatch_count > 0 %}
<div class="card border-warning shadow-sm mb-5">
    <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center">
        <span>üîç CSS Audit ‚Äî Developer Fix Report ({{ report.css_mismatch_count }} issues)</span>
        <a href="{% url 'validator:locate_all' pk=report.id %}" class="btn btn-sm btn-dark text-white no-print" target="_blank">üó∫Ô∏è View All Locations at Once</a>
    </div>
    <div class="card-body p-3" style="max-height: 600px; overflow-y: auto;">
        {% for m in report.raw_json_data.css_mismatches %}
        <div class="card mb-3 {% if m.severity == 'critical' %}border-danger{% elif m.severity == 'high' %}border-warning{% else %}border-info{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center py-2 {% if m.severity == 'critical' %}bg-danger text-white{% elif m.severity == 'high' %}bg-warning text-dark{% else %}bg-info text-white{% endif %}">
                <span class="fw-bold"><strong>#{{ forloop.counter }}</strong> ‚Äî {{ m.element }}</span>
                <span>
                    {% if m.severity == 'critical' %}
                        <span class="badge bg-light text-danger">üî¥ CRITICAL</span>
                    {% elif m.severity == 'high' %}
                        <span class="badge bg-light text-warning">üü† HIGH</span>
                    {% else %}
                        <span class="badge bg-light text-info">üîµ MEDIUM</span>
                    {% endif %}
                </span>
            </div>
            <div class="card-body py-2">
                {% if m.description %}
                <p class="mb-2 text-secondary" style="font-size: 0.9rem;"><strong>Problem:</strong> {{ m.description }}</p>
                {% endif %}
                <div class="row mb-2" style="font-size: 0.85rem;">
                    <div class="col-md-3"><strong>Property:</strong> <code>{{ m.property }}</code></div>
                    <div class="col-md-3"><strong>Expected:</strong> <span class="text-success fw-bold">{{ m.expected }}</span></div>
                    <div class="col-md-3"><strong>Actual:</strong> <span class="text-danger fw-bold">{{ m.actual }}</span></div>
                    <div class="col-md-3">
                        {% if m.location %}<strong>Location:</strong> <code>{{ m.location }}</code>{% endif %}
                    </div>
                </div>
                {% if m.selector %}
                <div class="mb-2" style="font-size: 0.85rem;">
                    <strong>CSS Selector:</strong> <code class="bg-light px-2 py-1 rounded border text-dark">{{ m.selector }}</code>
                </div>
                {% endif %}
                {% if m.css_fix %}
                <div class="mt-2">
                    <strong style="font-size: 0.85rem;">‚úÖ Suggested Fix:</strong>
                    <pre class="bg-dark text-success p-2 rounded mt-1 mb-0" style="font-size: 0.8rem; white-space: pre-wrap;"><code>{{ m.css_fix }}</code></pre>
                </div>
                {% endif %}
                {% if m.location %}
                <div class="mt-2 text-end">
                    <a href="{% url 'validator:locate' pk=report.id idx=forloop.counter0 %}" 
                       class="btn btn-sm btn-outline-danger no-print" target="_blank">
                        üìç View Exact Location on Page
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if report.raw_json_data.element_inventory %}
<div class="card border-primary shadow-sm mb-5">
    <div class="card-header bg-primary text-white fw-bold cursor-pointer" data-bs-toggle="collapse" data-bs-target="#inventoryCollapse" aria-expanded="false">
        üìã Live Page Element Inventory ({{ report.raw_json_data.element_inventory|length }} elements captured)
        <span class="float-end text-white-50">Click to expand</span>
    </div>
    <div class="collapse" id="inventoryCollapse">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-striped table-hover m-0" style="font-size: 0.8rem;">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>#</th>
                            <th>Element</th>
                            <th>Text</th>
                            <th>Position</th>
                            <th>Size</th>
                            <th>Font</th>
                            <th>Size</th>
                            <th>Weight</th>
                            <th>Color</th>
                            <th>Background</th>
                            <th>Line H.</th>
                            <th>Padding</th>
                            <th>Margin</th>
                        </tr>
                    </thead>
                    <tbody class="align-middle">
                        {% for el in report.raw_json_data.element_inventory %}
                        <tr>
                            <td class="text-muted">{{ forloop.counter }}</td>
                            <td class="fw-medium"><code style="font-size: 0.75rem;">{{ el.selector }}</code></td>
                            <td style="max-width: 120px;" class="text-truncate">{{ el.text }}</td>
                            <td><code>{{ el.position }}</code></td>
                            <td><code>{{ el.size }}</code></td>
                            <td style="max-width: 100px;" class="text-truncate">{{ el.font }}</td>
                            <td><code>{{ el.font_size }}</code></td>
                            <td>{{ el.font_weight }}</td>
                            <td><code>{{ el.color }}</code></td>
                            <td><code>{{ el.bg_color }}</code></td>
                            <td><code>{{ el.line_height }}</code></td>
                            <td style="max-width: 80px;" class="text-truncate"><code>{{ el.padding }}</code></td>
                            <td style="max-width: 80px;" class="text-truncate"><code>{{ el.margin }}</code></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-light text-muted small">
            Full computed CSS snapshot of every visible element. Developers can use this to compare against Zeplin specs.
        </div>
    </div>
</div>
{% endif %}

{% if report.js_error_count > 0 %}
<div class="card border-danger shadow-sm mb-5">
    <div class="card-header bg-danger text-white fw-bold">
        JavaScript Runtime Errors During Render
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover m-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Error Message</th>
                    </tr>
                </thead>
                <tbody class="align-middle">
                    {% for error in report.raw_json_data.js_errors %}
                    <tr>
                        <td class="fw-medium">{{ forloop.counter }}</td>
                        <td><code class="text-danger bg-light px-2 py-1 rounded border d-block text-wrap" style="max-height: 150px; overflow-y: auto;">{{ error }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if report.mismatch_regions %}
<div class="card border-info shadow-sm mb-5">
    <div class="card-header bg-info text-white fw-bold">
        Geometric Visual Failure Locations (Bounding Boxes)
    </div>
    <div class="card-body p-0">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-striped table-hover m-0">
                <thead class="table-light sticky-top">
                    <tr>
                        <th>Region #</th>
                        <th>X Coordinate</th>
                        <th>Y Coordinate</th>
                        <th>Width</th>
                        <th>Height</th>
                    </tr>
                </thead>
                <tbody class="align-middle">
                    {% for region in report.mismatch_regions %}
                    <tr>
                        <td class="fw-medium">Region {{ forloop.counter }}</td>
                        <td><code class="text-dark bg-light px-2 py-1 rounded border">{{ region.x }}px</code></td>
                        <td><code class="text-dark bg-light px-2 py-1 rounded border">{{ region.y }}px</code></td>
                        <td><code class="text-dark bg-light px-2 py-1 rounded border">{{ region.width }}px</code></td>
                        <td><code class="text-dark bg-light px-2 py-1 rounded border">{{ region.height }}px</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-light text-muted small">
        These coordinates map to the exact location on the Live Page representing contiguous blocks of differing pixels. Use these coordinates to pinpoint CSS misalignments or missing elements.
    </div>
</div>
</div>
{% endif %}

<div class="card shadow-sm mb-5">
    <div class="card-header bg-light fw-bold cursor-pointer" data-bs-toggle="collapse" data-bs-target="#debugCollapse" aria-expanded="false">
        Diagnostic Data (Click to Expand JSON)
        <span class="float-end text-muted text-sm">+/-</span>
    </div>
    <div class="collapse" id="debugCollapse">
        <div class="card-body bg-light">
            <pre class="m-0" style="max-height: 500px; overflow: auto;"><code>{{ report.raw_json_data }}</code></pre>
        </div>
    </div>
</div>

<!-- Code Preview Modal -->
<div class="modal fade" id="codePreviewModal" tabindex="-1" aria-labelledby="codePreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="codePreviewModalLabel">Standalone HTML Source Code</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body bg-light">
          <p class="text-muted small mb-2">This is the fully self-contained HTML file. All CSS, JavaScript, and Images have been converted to inline strings and Base64 data.</p>
          <textarea id="codePreviewArea" class="form-control font-monospace" style="font-size: 12px; height: 500px;" readonly></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary fw-bold" onclick="triggerStandaloneDownload()"><i class="bi bi-download"></i> Save HTML File</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function downloadPDF() {
    // Expand all collapsed sections so they appear in the PDF
    document.querySelectorAll('.collapse').forEach(el => {
        el.classList.add('show');
    });
    
    // Set the document title for the PDF filename
    const originalTitle = document.title;
    document.title = 'Validation_Report_{{ report.id }}_{{ report.zeplin_screen_id }}';
    
    // Trigger the browser's Save as PDF dialog
    window.print();
    
    // Restore original title
    document.title = originalTitle;
}

let standaloneHtmlString = "";

async function generateStandaloneHTML() {
    const clone = document.documentElement.cloneNode(true);
    
    // Hide 'no-print' elements from the clone (like validation buttons)
    clone.querySelectorAll('.no-print').forEach(el => el.remove());
    // Remove the modal from the clone so it doesn't take up space in the saved file
    const modalEl = clone.querySelector('#codePreviewModal');
    if (modalEl) modalEl.remove();
    
    // Expand collapses
    clone.querySelectorAll('.collapse').forEach(el => el.classList.add('show'));

    // 1. Inline Images via Base64
    const imgs = clone.querySelectorAll('img');
    for (const img of imgs) {
        if (!img.src || img.src.startsWith('data:')) continue;
        try {
            const resp = await fetch(img.src);
            const blob = await resp.blob();
            const reader = new FileReader();
            await new Promise(r => {
                reader.onloadend = r;
                reader.readAsDataURL(blob);
            });
            img.src = reader.result;
        } catch(e) { console.error("Could not inline image", img.src, e); }
    }
    
    // 2. Inline CSS
    const links = clone.querySelectorAll('link[rel="stylesheet"]');
    for (const link of links) {
        if (!link.href) continue;
        try {
            const resp = await fetch(link.href);
            const cssText = await resp.text();
            const style = document.createElement('style');
            style.textContent = cssText;
            link.replaceWith(style);
        } catch(e) { console.error("Could not inline CSS", link.href, e); }
    }
    
    // 3. Inline JS
    const scripts = clone.querySelectorAll('script[src]');
    for (const script of scripts) {
        if (!script.src) continue;
        try {
            const resp = await fetch(script.src);
            const jsText = await resp.text();
            const inlineScript = document.createElement('script');
            inlineScript.textContent = jsText;
            script.replaceWith(inlineScript);
        } catch(e) { console.error("Could not inline JS", script.src, e); }
    }
    
    return '<!DOCTYPE html>\n' + clone.outerHTML;
}

async function previewAndDownloadHTML() {
    const btn = document.getElementById('btnPreviewHtml');
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Extracting Assets...';
    btn.disabled = true;
    
    try {
        standaloneHtmlString = await generateStandaloneHTML();
        
        document.getElementById('codePreviewArea').value = standaloneHtmlString;
        const modal = new bootstrap.Modal(document.getElementById('codePreviewModal'));
        modal.show();
    } catch (e) {
        alert("Failed to generate standalone HTML: " + e);
    }
    
    btn.innerHTML = originalText;
    btn.disabled = false;
}

function triggerStandaloneDownload() {
    const blob = new Blob([standaloneHtmlString], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `Validation_Report_{{ report.id }}_${new Date().toISOString().slice(0,10)}.html`;
    a.target = '_blank';
    document.body.appendChild(a);
    
    const clickEvent = new MouseEvent('click', {
        view: window,
        bubbles: true,
        cancelable: false
    });
    a.dispatchEvent(clickEvent);
    
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
}
</script>
{% endblock %}
